<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.ly.sys.core.resource.dao.ResourceDao">
	<resultMap id="resourceResult" type="Resource">
		<id property="id" column="id" javaType="Long" />
		<result property="name" column="name" javaType="String" />
		<result property="source" column="source" javaType="String" />
		<result property="identity" column="identity" javaType="String" />
		<result property="url" column="url" javaType="String" />
		<result property="parentId" column="parent_id" javaType="Long" />
		<result property="parentIds" column="parent_ids" javaType="String" />
		<result property="icon" column="icon" javaType="String" />
		<result property="weight" column="weight" javaType="Integer" />
		<result property="isParent" column="is_parent" javaType="String" />
		<result property="isShow" column="is_show" javaType="Integer" />
		<result property="deleted" column="deleted" javaType="Integer" />
	</resultMap>


	<sql id="queryResourceSql">
		<where>
      	<![CDATA[
			1=1
		 ]]>
			<if test="id!=null">
			<![CDATA[
				and T.id=#{id}
			]]>
			</if>
			<if test="name!=null">
			<![CDATA[
				and T.name like concat("%",#{name},"%")
			]]>
			</if>
			<if test="source!=null">
			<![CDATA[
				and T.source=#{source}
			]]>
			</if>
			<if test="identity!=null">
			<![CDATA[
				and T.identity=#{identity}
			]]>
			</if>
			<if test="url!=null">
			<![CDATA[
				and T.url=#{url}
			]]>
			</if>
			<if test="parentId!=null">
			<![CDATA[
				and T.parent_id=#{parentId}
			]]>
			</if>

			<if test="parentIds!=null">
				and T.parent_id in
				<foreach collection="parentIds" index="index" item="parentId"
					open="(" separator="," close=")">
					#{parentId}
				</foreach>
			</if>
			<if test="icon!=null">
			<![CDATA[
				and T.icon=#{icon}
			]]>
			</if>
			<if test="weight!=null">
			<![CDATA[
				and T.weight=#{weight}
			]]>
			</if>
			<if test="isParent!=null">
			<![CDATA[
				and T.is_parent=#{isParent}
			]]>
			</if>
			<if test="isShow!=null">
			<![CDATA[
				and T.is_show=#{isShow}
			]]>
			</if>
			<if test="deleted!=null">
			<![CDATA[
				and T.deleted=#{deleted}
			]]>
			</if>
			<!-- 查询一个父列表的所有子节点 -->
			<if test="parentList!=null">
				and T.parent_id in
				<foreach collection="parentList" item="resource" index="index"
					open="(" close=")" separator=",">
					#{resource.parentId}
				</foreach>
			</if>
		</where>
	</sql>


	<select id="findById" resultMap="resourceResult" parameterType="long">
		<![CDATA[
		SELECT
		*
		FROM sys_resource WHERE id=#{id}
		]]>
	</select>

	<select id="findPageList" resultMap="resourceResult"
		parameterType="map">
		<![CDATA[
			SELECT T.* FROM sys_resource T 
    	]]>
		<include refid="queryResourceSql" />

	</select>

	<select id="findList" resultMap="resourceResult" parameterType="map">
		<![CDATA[
			SELECT T.* FROM sys_resource T 
    	]]>
		<include refid="queryResourceSql" />
    	<![CDATA[
		   ORDER BY T.weight DESC,T.id DESC 
		]]>
	</select>
	

	<select id="findListByQuery" resultMap="resourceResult"
		parameterType="map">
		<![CDATA[
			SELECT T.* FROM sys_resource T 
    	]]>
		<include refid="queryResourceSql" />
    	<![CDATA[
		   ORDER BY T.id DESC 
		]]>

	</select>

	<select id="findCountChildrenByParentId" resultType="Integer"
		parameterType="map">
		<![CDATA[
			SELECT COUNT(T.id) FROM sys_resource T 
      WHERE 1=1 AND T.parent_id =#{parentId}
    	]]>
    	
    	<![CDATA[
		   ORDER BY T.id DESC 
		]]>

	</select>

	<select id="findCount" resultType="Integer" parameterType="map">
		<![CDATA[
        	SELECT COUNT(1) FROM sys_resource T
    	]]>
		<include refid="queryResourceSql" />
	</select>

	<insert id="insert" parameterType="Resource">
		<![CDATA[
			INSERT INTO sys_resource(
												id,
												name,
												source,
												identity,
												url,
												parent_id,
												parent_ids,
												icon,
												weight,
												is_parent,
												is_show,
												deleted
									)VALUES(
								#{id},
												#{name},
												#{source},
												#{identity},
												#{url},
												#{parentId},
												#{parentIds},
												#{icon},
												#{weight},
												#{isParent},
												#{isShow},
												#{deleted}
									)
		]]>
		<selectKey resultType="long" keyProperty="id">
			SELECT
			LAST_INSERT_ID() AS ID
		</selectKey>
	</insert>

	<update id="update" parameterType="Resource">
		<![CDATA[
			UPDATE sys_resource SET
														name=#{name},
																source=#{source},
																identity=#{identity},
																url=#{url},
																parent_id=#{parentId},
																parent_ids=#{parentIds},
																icon=#{icon},
																weight=#{weight},
																is_parent=#{isParent},
																is_show=#{isShow},
																deleted=#{deleted}
										WHERE id=#{id}
		]]>
	</update>

	<delete id="delete" parameterType="long">
		<![CDATA[
			DELETE FROM sys_resource WHERE id=#{id}
		]]>
	</delete>

	<delete id="deleteChild" parameterType="list">
		delete FROM sys_resource
		where id in
		<foreach collection="list" item="resource" index="index" open="("
			close=")" separator=",">
			#{resource.id}
		</foreach>

	</delete>
	<select id="getNextWeight" parameterType="long" resultType="Integer">
		SELECT CASE
		WHEN max(weight) IS NULL
		THEN 1
		ELSE (max(weight) + 1)
		END
		FROM sys_resource
		WHERE parent_id = #{id}
	</select>
	<select id="findSelfAndNextSiblings" parameterType="map"
		resultMap="resourceResult">
		select *
		from sys_resource
		<where>
			<if test="parentIds !=null">
				and parent_ids=#{parentIds}
			</if>
			<if test="weight!=null">
				and weight>=#{weight}
			</if>
		</where>
		order by weight asc
	</select>
	<update id="batchUpdate">
		update t set
		parent_ids=replace(parent_ids,#{oldSourceChildrenParentIds},#{newSourceChildrenParentIds})
		where parent_ids like concat(#{oldSourceChildrenParentIds},"%")
	</update>
	<select id="findTreeListWithSort" parameterType="map" resultMap="resourceResult">
		select T.*
		from sys_resource T
		<include refid="queryResourceSql" />
		order by T.parent_Ids ASC,
		T.weight ASC
	</select>
</mapper>
